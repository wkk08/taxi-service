name: Taxi Service CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
        - production

env:
  # é…ç½®å˜é‡
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  K8S_NAMESPACE: taxi-${{ github.event.inputs.environment || 'development' }}
  
  # ç‰ˆæœ¬æ§åˆ¶
  VERSION: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
  BUILD_DATE: ${{ github.event.head_commit.timestamp || github.run_started_at }}

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.environment == 'development'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼ˆç”¨äºgit blameç­‰ï¼‰
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install black==23.11.0 flake8==6.1.0 pylint==3.0.2 mypy==1.6.1 bandit==1.7.5
    
    - name: Check Python syntax
      run: |
        python -m py_compile src/**/*.py
    
    - name: Check imports with isort
      run: |
        pip install isort
        isort --check-only --profile black src/
    
    - name: Format check with Black
      run: |
        black --check --diff src/ tests/
    
    - name: Lint with Flake8
      run: |
        flake8 src/ --max-line-length=88 --extend-ignore=E203,W503,E501 --statistics
    
    - name: Static type checking with MyPy
      run: |
        mypy src/ --ignore-missing-imports
    
    - name: Security scan with Bandit
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
    
    - name: Upload code quality reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          bandit-report.json
        retention-days: 30

  # ç¬¬äºŒé˜¶æ®µï¼šå•å…ƒæµ‹è¯•
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.environment == 'development'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist
    
    - name: Create test database
      run: |
        # åˆ›å»ºæµ‹è¯•ç”¨çš„SQLiteæ•°æ®åº“
        mkdir -p tests/data
        touch tests/data/test.db
    
    - name: Run unit tests with coverage
      run: |
        python -m pytest tests/unit/ -v \
          --cov=src \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term \
          --junitxml=junit.xml \
          --numprocesses=auto
    
    - name: Check coverage threshold
      run: |
        python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('coverage.xml')
        root = tree.getroot()
        coverage = float(root.attrib['line-rate']) * 100
        print(f'ä»£ç è¦†ç›–ç‡: {coverage:.2f}%')
        if coverage < 70:
            print('âŒ è¦†ç›–ç‡ä½äº70%')
            exit(1)
        else:
            print('âœ… è¦†ç›–ç‡è¾¾æ ‡')
        "
    
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          coverage.xml
          htmlcov/
          junit.xml
        retention-days: 30

  # ç¬¬ä¸‰é˜¶æ®µï¼šé›†æˆæµ‹è¯•
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.environment == 'development'
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest requests
    
    - name: Run integration tests
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        REDIS_URL: redis://localhost:6379/0
        TESTING: "true"
      run: |
        # å¯åŠ¨åº”ç”¨è¿›è¡Œé›†æˆæµ‹è¯•
        python run.py &
        APP_PID=$!
        
        # ç­‰å¾…åº”ç”¨å¯åŠ¨
        echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
        for i in {1..30}; do
          if curl -s http://localhost:5000/health > /dev/null; then
            echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ"
            break
          fi
          sleep 2
          echo "ç­‰å¾…åº”ç”¨å¯åŠ¨... ($i/30)"
        done
        
        # è¿è¡ŒAPIæµ‹è¯•
        echo "è¿è¡ŒAPIæµ‹è¯•..."
        
        # æµ‹è¯•å¥åº·ç«¯ç‚¹
        curl -f http://localhost:5000/health || (echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"; exit 1)
        
        # æµ‹è¯•è®¤è¯API
        curl -X POST http://localhost:5000/api/auth/register \
          -H "Content-Type: application/json" \
          -d '{"email":"test@example.com","username":"testuser","password":"Test123!","role":"passenger"}' \
          --fail || echo "âš ï¸ æ³¨å†Œæµ‹è¯•è·³è¿‡"
        
        # æµ‹è¯•ä¸»APIç«¯ç‚¹
        curl -f http://localhost:5000/ || (echo "âŒ ä¸»APIç«¯ç‚¹å¤±è´¥"; exit 1)
        
        # æµ‹è¯•å…¶ä»–ç«¯ç‚¹
        curl -f http://localhost:5000/api/test || (echo "âŒ APIæµ‹è¯•ç«¯ç‚¹å¤±è´¥"; exit 1)
        curl -f http://localhost:5000/api/auth/test || (echo "âŒ è®¤è¯APIæµ‹è¯•ç«¯ç‚¹å¤±è´¥"; exit 1)
        
        echo "âœ… æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡"
        
        # åœæ­¢åº”ç”¨
        kill $APP_PID 2>/dev/null || true
    
    - name: Run database migration test
      run: |
        # æµ‹è¯•æ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœæœ‰ï¼‰
        if [ -f migrations/ ]; then
          echo "è¿è¡Œæ•°æ®åº“è¿ç§»æµ‹è¯•..."
          # è¿™é‡Œæ·»åŠ è¿ç§»æµ‹è¯•å‘½ä»¤
        else
          echo "æ²¡æœ‰æ•°æ®åº“è¿ç§»ï¼Œè·³è¿‡"
        fi

  # ç¬¬å››é˜¶æ®µï¼šæ„å»ºDockeré•œåƒ
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:master
          network=host
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=schedule
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
        labels: |
          org.opencontainers.image.title=Taxi Service
          org.opencontainers.image.description=å‡ºç§Ÿè½¦æœåŠ¡ç³»ç»Ÿ
          org.opencontainers.image.version=${{ github.ref_name }}
          org.opencontainers.image.created=${{ env.BUILD_DATE }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
    
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
        build-args: |
          BUILDKIT_INLINE_CACHE=1
          VERSION=${{ github.sha }}
          BUILD_DATE=${{ env.BUILD_DATE }}
    
    - name: Scan image for vulnerabilities
      if: github.event_name != 'pull_request'
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-scan-results
        path: trivy-results.sarif
    
    - name: Store image metadata
      run: |
        echo "é•œåƒæ„å»ºå®Œæˆ:"
        echo "Tags: ${{ steps.meta.outputs.tags }}"
        echo "Digest: ${{ steps.build.outputs.digest }}"
        
        # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "IMAGE_TAGS=${{ steps.meta.outputs.tags }}" >> $GITHUB_ENV
        echo "IMAGE_DIGEST=${{ steps.build.outputs.digest }}" >> $GITHUB_ENV

  # ç¬¬äº”é˜¶æ®µï¼šéƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.taxi.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
    
    - name: Configure Kubernetes
      run: |
        # é…ç½®Kubernetesè®¿é—®ï¼ˆç¤ºä¾‹ï¼Œå®é™…éœ€è¦ä½ çš„é›†ç¾¤é…ç½®ï¼‰
        echo "é…ç½®Kubernetesè®¿é—®..."
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 --decode > ~/.kube/config
        
        # éªŒè¯è¿æ¥
        kubectl cluster-info
        kubectl get nodes
    
    - name: Deploy to Kubernetes
      run: |
        # æ›´æ–°deployment.yamlä¸­çš„é•œåƒæ ‡ç­¾
        sed -i "s|image:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}|" kubernetes/deployment.yaml
        
        # åº”ç”¨Kubernetesé…ç½®
        kubectl apply -f kubernetes/namespace.yaml
        kubectl apply -f kubernetes/configmap.yaml
        kubectl apply -f kubernetes/secrets.yaml
        kubectl apply -f kubernetes/deployment.yaml
        kubectl apply -f kubernetes/service.yaml
        kubectl apply -f kubernetes/ingress.yaml
        
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        kubectl rollout status deployment/taxi-service -n ${{ env.K8S_NAMESPACE }} --timeout=300s
        
        # è·å–æœåŠ¡ä¿¡æ¯
        echo "éƒ¨ç½²å®Œæˆï¼"
        kubectl get all -n ${{ env.K8S_NAMESPACE }}
    
    - name: Run smoke tests
      run: |
        # ç®€å•çš„å†’çƒŸæµ‹è¯•
        echo "è¿è¡Œå†’çƒŸæµ‹è¯•..."
        
        # è·å–æœåŠ¡URLï¼ˆè¿™é‡Œç®€åŒ–ï¼Œå®é™…åº”è¯¥ä»Kubernetesè·å–ï¼‰
        SERVICE_URL="http://staging.taxi.example.com"
        
        # æµ‹è¯•å¥åº·ç«¯ç‚¹
        curl -f $SERVICE_URL/health || (echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"; exit 1)
        
        # æµ‹è¯•APIç«¯ç‚¹
        curl -f $SERVICE_URL/ || (echo "âŒ APIç«¯ç‚¹å¤±è´¥"; exit 1)
        
        echo "âœ… å†’çƒŸæµ‹è¯•é€šè¿‡"

  # ç¬¬å…­é˜¶æ®µï¼šéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: 
      - build-docker
      - deploy-staging
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://taxi.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
    
    - name: Configure Kubernetes
      run: |
        # é…ç½®ç”Ÿäº§ç¯å¢ƒKubernetesè®¿é—®
        echo "é…ç½®ç”Ÿäº§ç¯å¢ƒKubernetesè®¿é—®..."
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 --decode > ~/.kube/config
        
        # éªŒè¯è¿æ¥
        kubectl cluster-info
        kubectl get nodes
    
    - name: Deploy to Production
      run: |
        echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
        
        # æ›´æ–°é•œåƒæ ‡ç­¾
        sed -i "s|image:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}|" kubernetes/production/deployment.yaml
        
        # åº”ç”¨è“ç»¿éƒ¨ç½²ç­–ç•¥
        CURRENT_COLOR=$(kubectl get svc taxi-service -n production -o jsonpath='{.spec.selector.color}')
        
        if [ "$CURRENT_COLOR" = "blue" ]; then
          NEW_COLOR="green"
        else
          NEW_COLOR="blue"
        fi
        
        echo "å½“å‰é¢œè‰²: $CURRENT_COLOR, éƒ¨ç½²åˆ°: $NEW_COLOR"
        
        # éƒ¨ç½²æ–°ç‰ˆæœ¬
        sed -i "s|color:.*|color: $NEW_COLOR|" kubernetes/production/deployment.yaml
        kubectl apply -f kubernetes/production/deployment-$NEW_COLOR.yaml
        
        # ç­‰å¾…æ–°ç‰ˆæœ¬å°±ç»ª
        kubectl rollout status deployment/taxi-service-$NEW_COLOR -n production --timeout=300s
        
        # åˆ‡æ¢æµé‡
        kubectl patch service taxi-service -n production -p "{\"spec\":{\"selector\":{\"color\":\"$NEW_COLOR\"}}}"
        
        echo "âœ… è“ç»¿éƒ¨ç½²å®Œæˆï¼Œå½“å‰æ´»è·ƒé¢œè‰²: $NEW_COLOR"
    
    - name: Run production smoke tests
      run: |
        echo "è¿è¡Œç”Ÿäº§ç¯å¢ƒå†’çƒŸæµ‹è¯•..."
        
        PRODUCTION_URL="https://taxi.example.com"
        
        # æµ‹è¯•å¥åº·ç«¯ç‚¹
        curl -f $PRODUCTION_URL/health || (echo "âŒ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥"; exit 1)
        
        # æµ‹è¯•å…³é”®ä¸šåŠ¡åŠŸèƒ½
        curl -f $PRODUCTION_URL/api/test || (echo "âŒ ç”Ÿäº§ç¯å¢ƒAPIæµ‹è¯•å¤±è´¥"; exit 1)
        
        echo "âœ… ç”Ÿäº§ç¯å¢ƒå†’çƒŸæµ‹è¯•é€šè¿‡"
    
    - name: Create GitHub release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: |
          # Taxi Service ç”Ÿäº§å‘å¸ƒ
          
          ## å˜æ›´æ‘˜è¦
          - è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²
          - é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          - æäº¤: ${{ github.event.head_commit.message }}
          
          ## éƒ¨ç½²çŠ¶æ€
          âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ
          
          ## è®¿é—®åœ°å€
          - ç”Ÿäº§ç¯å¢ƒ: https://taxi.example.com
          - å¥åº·æ£€æŸ¥: https://taxi.example.com/health
          
          ## ç›‘æ§
          - [Grafana Dashboard](https://grafana.example.com)
          - [Prometheus](https://prometheus.example.com)
        draft: false
        prerelease: false

  # ç¬¬ä¸ƒé˜¶æ®µï¼šé€šçŸ¥å’ŒæŠ¥å‘Š
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [build-docker, deploy-production]
    if: always()
    
    steps:
    - name: Send success notification
      if: success()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_CHANNEL: deployments
        SLACK_TITLE: "âœ… éƒ¨ç½²æˆåŠŸ - Taxi Service"
        SLACK_MESSAGE: |
          ç‰ˆæœ¬: ${{ github.sha }}
          ç¯å¢ƒ: Production
          æ—¶é—´: ${{ env.BUILD_DATE }}
          é“¾æ¥: https://taxi.example.com
        SLACK_COLOR: "good"
    
    - name: Send failure notification
      if: failure()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_CHANNEL: deployments
        SLACK_TITLE: "âŒ éƒ¨ç½²å¤±è´¥ - Taxi Service"
        SLACK_MESSAGE: |
          ç‰ˆæœ¬: ${{ github.sha }}
          å¤±è´¥æ­¥éª¤: ${{ needs.*.result }}
          è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        SLACK_COLOR: "danger"
    
    - name: Generate deployment report
      run: |
        echo "# Deployment Report" > report.md
        echo "" >> report.md
        echo "## Summary" >> report.md
        echo "- **Repository**: ${{ github.repository }}" >> report.md
        echo "- **Commit**: ${{ github.sha }}" >> report.md
        echo "- **Branch**: ${{ github.ref }}" >> report.md
        echo "- **Timestamp**: ${{ env.BUILD_DATE }}" >> report.md
        echo "" >> report.md
        
        echo "## Job Results" >> report.md
        echo "| Job | Status |" >> report.md
        echo "|-----|--------|" >> report.md
        echo "| Code Quality | ${{ needs.code-quality.result || 'skipped' }} |" >> report.md
        echo "| Unit Tests | ${{ needs.unit-tests.result || 'skipped' }} |" >> report.md
        echo "| Integration Tests | ${{ needs.integration-tests.result || 'skipped' }} |" >> report.md
        echo "| Build Docker | ${{ needs.build-docker.result || 'skipped' }} |" >> report.md
        echo "| Deploy Staging | ${{ needs.deploy-staging.result || 'skipped' }} |" >> report.md
        echo "| Deploy Production | ${{ needs.deploy-production.result || 'skipped' }} |" >> report.md
        echo "" >> report.md
        
        echo "## Docker Image" >> report.md
        echo "- **Registry**: ${{ env.REGISTRY }}" >> report.md
        echo "- **Image**: ${{ env.IMAGE_NAME }}" >> report.md
        echo "- **Tags**: ${{ env.IMAGE_TAGS }}" >> report.md
        echo "" >> report.md
        
        echo "## Links" >> report.md
        echo "- [GitHub Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> report.md
        echo "- [Docker Image](https://ghcr.io/${{ github.repository }})" >> report.md
        echo "- [Production URL](https://taxi.example.com)" >> report.md
    
    - name: Upload deployment report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: report.md
        retention-days: 90